@{
    ViewData["Title"] = "Export Data";
}

<h2>Export Data</h2>

<!-- Dropdown pro export Hive a Apiary measurements -->
<div>
    <h3>Export Hive Measurements</h3>
    <select id="hiveMeasurementPeriod" class="form-select">
        <option value="24h">Posledních 24 hodin</option>
        <option value="7d">Posledních 7 dní</option>
        <option value="30d">Posledních 30 dní</option>
        <option value="all">Všechna data</option>
    </select>
    <button class="btn btn-primary mt-2" onclick="exportData('HiveMeasurements', 'csv')">Export CSV</button>
    <button class="btn btn-primary mt-2" onclick="exportData('HiveMeasurements', 'json')">Export JSON</button>
</div>

<div>
    <h3>Export Apiary Measurements</h3>
    <select id="apiaryMeasurementPeriod" class="form-select">
        <option value="24h">Posledních 24 hodin</option>
        <option value="7d">Posledních 7 dní</option>
        <option value="30d">Posledních 30 dní</option>
        <option value="all">Všechna data</option>
    </select>
    <button class="btn btn-primary mt-2" onclick="exportData('ApiaryMeasurements', 'csv')">Export CSV</button>
    <button class="btn btn-primary mt-2" onclick="exportData('ApiaryMeasurements', 'json')">Export JSON</button>
</div>

<!-- Tabulka s checkboxy pro výběr entit -->
<div class="mt-4">
    <h3>Export vybraných entit</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Entity</th>
                <th>Choose</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Hives</td>
                <td><input type="checkbox" value="Hives" class="entity-checkbox" /></td>
            </tr>
            <tr>
                <td>Apiary</td>
                <td><input type="checkbox" value="Apiary" class="entity-checkbox" /></td>
            </tr>
            <tr>
                <td>Apiary Measurement</td>
                <td><input type="checkbox" value="ApiaryMeasurement" class="entity-checkbox" /></td>
            </tr>
            <tr>
                <td>Hive Measurement</td>
                <td><input type="checkbox" value="HiveMeasurement" class="entity-checkbox" /></td>
            </tr>
            <tr>
                <td>Inspection Report</td>
                <td><input type="checkbox" value="InspectionReport" class="entity-checkbox" /></td>
            </tr>
        </tbody>
    </table>
    <button class="btn btn-secondary" onclick="exportSelectedEntities()">Export</button>
</div>

<script>
    function exportData(table, format) {
        const period = document.getElementById("hiveMeasurementPeriod").value;

        fetch('/ExportData/ExportData', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table, period, format })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error("Chyba při exportu dat");
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${table}_${format}_${new Date().toISOString().replace(/[:.]/g, '-')}.` + (format === 'json' ? 'json' : 'csv');
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error(error));
    }

    function exportSelectedEntities() {
        // Získání vybraných entit
        const selectedEntities = Array.from(document.querySelectorAll('.entity-checkbox:checked')).map(checkbox => checkbox.value);

        if (selectedEntities.length === 0) {
            alert('Prosím, vyberte alespoň jednu entitu.');
            return;
        }

        fetch('/ExportData/ExportSelectedEntities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ entities: selectedEntities })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                throw new Error("Chyba při exportu vybraných entit");
            }
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `selected_entities_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`; // Zde se předpokládá CSV formát
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error(error));
    }
</script>